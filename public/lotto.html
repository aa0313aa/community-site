<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¡œë˜í™•ì¸ - ì—…ì²´ì •ë³´ ì»¤ë®¤ë‹ˆí‹°</title>
  <meta name="robots" content="noindex,nofollow" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='50' x='6' font-size='48'%3E%F0%9F%8E%AF%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .lotto-ball { width:56px; height:56px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; font-weight:700; color:#fff; font-size:20px; box-shadow:inset 0 -2px 0 rgba(0,0,0,.12); }
    .lotto-card { background:#fff; border-radius:14px; box-shadow:0 12px 36px rgba(15,23,42,.12); border:1px solid rgba(15,23,42,.06); }
    .lotto-divider { height:1px; background:linear-gradient(90deg,rgba(226,232,240,0),rgba(148,163,184,.7),rgba(226,232,240,0)); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="bg-white border-b">
    <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl font-bold text-blue-600">ğŸ’³ ì—…ì²´ì •ë³´ ì»¤ë®¤ë‹ˆí‹°</h1>
      <a href="/" class="text-sm text-gray-600 hover:underline">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-8">
    <div class="lotto-card p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <p class="text-xs uppercase tracking-wide text-emerald-600 font-semibold">ë™í–‰ë³µê¶Œ ì‹¤ì‹œê°„ ì—°ë™</p>
          <h2 id="lottoRoundLabel" class="text-2xl font-bold mt-1">ë¡œë”© ì¤‘...</h2>
          <p id="lottoRoundDate" class="text-sm text-slate-500"></p>
        </div>
        <div class="flex items-center gap-2">
          <button id="refreshLatestBtn" class="px-3 py-1.5 text-sm border border-slate-200 rounded hover:bg-slate-50">ìµœì‹ íšŒì°¨</button>
        </div>
      </div>

      <div class="space-y-4">
        <div class="flex items-center gap-3">
          <button id="lottoPrevBtn" class="px-3 py-1.5 bg-slate-100 rounded hover:bg-slate-200 disabled:opacity-40" disabled>â† ì´ì „ íšŒì°¨</button>
          <button id="lottoNextBtn" class="px-3 py-1.5 bg-slate-100 rounded hover:bg-slate-200 disabled:opacity-40" disabled>ë‹¤ìŒ íšŒì°¨ â†’</button>
          <div class="flex items-center gap-2 ml-auto">
            <span class="text-sm">íšŒì°¨ ì´ë™</span>
            <input id="lottoRoundInput" type="number" min="1" class="w-32 border rounded px-2 py-1" placeholder="ì˜ˆ: 1198" />
            <button id="lottoJumpBtn" class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700">í™•ì¸</button>
          </div>
        </div>

        <div id="lottoStatus" class="text-sm text-slate-500"></div>

        <div>
          <div id="lottoNumbers" class="flex items-center gap-3 mb-3"></div>
          <div class="flex items-center gap-2 text-sm text-slate-500">
            <span>ë³´ë„ˆìŠ¤</span>
            <span id="lottoBonus" class="lotto-ball bg-slate-600"></span>
          </div>
        </div>

        <div>
          <div id="lottoPrize" class="text-lg font-semibold text-slate-800"></div>
          <div class="mt-3 text-sm text-slate-600">
            <p>â€» ì •ë³´ëŠ” ë™í–‰ë³µê¶Œ API ê¸°ë°˜ì´ë©° ì •í™•í•œ ë‚´ìš©ì€ ê³µì‹ ì‚¬ì´íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
            <p class="mt-2"><a href="https://www.dhlottery.co.kr/gameResult.do?method=byWin" target="_blank" rel="noopener" class="text-blue-600 hover:underline">ë™í–‰ë³µê¶Œ ì‚¬ì´íŠ¸</a></p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="border-t bg-white mt-12">
    <div class="max-w-4xl mx-auto px-4 py-6 text-sm text-gray-500 text-center">Â© <span id="year"></span> ì—…ì²´ì •ë³´ ì»¤ë®¤ë‹ˆí‹°</div>
  </footer>

  <script>
    const $ = s => document.querySelector(s);
    const lottoState = { cache: new Map(), currentRound: null, latestRound: null, isLoading: false };
    const LOTTO_API_BASE = '/api/lotto';

    function setLottoStatus(message = '', isError = false, allowHtml = false) {
      const box = $('#lottoStatus');
      if (!box) return;
      if (allowHtml) box.innerHTML = message || '';
      else box.textContent = message || '';
      box.classList.remove('text-red-500', 'text-slate-500');
      box.classList.add(isError ? 'text-red-500' : 'text-slate-500');
    }

    function getLottoBallColor(num) {
      if (num <= 10) return 'bg-yellow-400 text-gray-900';
      if (num <= 20) return 'bg-blue-500';
      if (num <= 30) return 'bg-red-500';
      if (num <= 40) return 'bg-gray-700';
      return 'bg-green-500';
    }

    function renderLottoView(data) {
      if (!data) return;
      lottoState.currentRound = data.round;
      if (!lottoState.latestRound || data.round > lottoState.latestRound) lottoState.latestRound = data.round;

      $('#lottoRoundLabel').textContent = `${data.round}íšŒì°¨`;
      $('#lottoRoundDate').textContent = data.drawDate ? `${data.drawDate} ì¶”ì²¨` : '';
      $('#lottoRoundInput').value = data.round;

      const numsEl = $('#lottoNumbers');
      if (numsEl) {
        numsEl.innerHTML = data.numbers.map(num => `<span class="lotto-ball ${getLottoBallColor(num)}">${num}</span>`).join('');
      }
      const bonusEl = $('#lottoBonus');
      if (bonusEl) {
        bonusEl.textContent = data.bonus;
        bonusEl.className = `lotto-ball ${getLottoBallColor(data.bonus)}`;
      }

      const formatWon = (val) => {
        const n = Number(val || 0);
        if (!Number.isFinite(n)) return '-';
        return n.toLocaleString('ko-KR');
      };

      const prizeEl = $('#lottoPrize');
      if (prizeEl) {
        prizeEl.innerHTML = `1ë“± ë‹¹ì²¨ê¸ˆ <span class="text-blue-600 font-bold">${formatWon(data.firstPrize)}ì›</span> Â· ë‹¹ì²¨ ë³µê¶Œ ìˆ˜ ${data.firstWinners || 0}ê°œ Â· ì´ íŒë§¤ê¸ˆì•¡ ${formatWon(data.salesAmount)}ì›`;
      }

      updateLottoNavButtons();
      setLottoStatus('');
    }

    function updateLottoNavButtons() {
      const prevBtn = $('#lottoPrevBtn');
      const nextBtn = $('#lottoNextBtn');
      if (prevBtn) prevBtn.disabled = lottoState.isLoading || !lottoState.currentRound || lottoState.currentRound <= 1;
      if (nextBtn) nextBtn.disabled = lottoState.isLoading || !lottoState.currentRound || (lottoState.latestRound && lottoState.currentRound >= lottoState.latestRound);
    }

    async function fetchLottoRound(round) {
      if (!round || round < 1) return null;
      try {
        const res = await fetch(`${LOTTO_API_BASE}?drwNo=${round}`, { cache: 'no-store' });
        if (!res.ok) return null;
        const json = await res.json();
        if (json.returnValue !== 'success') return null;
        return {
          round: json.drwNo,
          drawDate: json.drwNoDate,
          numbers: [json.drwtNo1, json.drwtNo2, json.drwtNo3, json.drwtNo4, json.drwtNo5, json.drwtNo6],
          bonus: json.bnusNo,
          firstPrize: Number(json.firstWinamnt || 0),
          firstWinners: json.firstPrzwnerCo || 0,
          salesAmount: Number(json.totSellamnt || 0)
        };
      } catch (err) {
        console.error('ë™í–‰ë³µê¶Œ API í˜¸ì¶œ ì‹¤íŒ¨', err);
        return null;
      }
    }

    async function findLatestLottoRound() {
      const MAX_API_CALLS = 200; let calls = 0;
      const tryFetch = async (n) => { if (!n||n<1) return null; if (calls>=MAX_API_CALLS) return null; calls+=1; return await fetchLottoRound(n); };

      let start = lottoState.latestRound || 1200;
      let data = await tryFetch(start);
      if (!data) {
        let guess = start - 1; while (guess > 0 && calls < MAX_API_CALLS) { const d = await tryFetch(guess); if (d) { data = d; start = guess; break; } guess -= 1; }
      }
      if (!data) {
        let low = 1; let high = 1024; while (calls < MAX_API_CALLS) { const d = await tryFetch(high); if (d) { data = d; low = high; high = high * 2; if (high > 5000) break; continue; } break; }
        if (!data) throw new Error('ìµœì‹  íšŒì°¨ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        let lo = Math.max(1, Math.floor(low/2)); let hi = high; while (lo <= hi && calls < MAX_API_CALLS) { const mid = Math.floor((lo+hi)/2); const d = await tryFetch(mid); if (d) { data = d; lo = mid+1; } else { hi = mid-1; } }
        return data;
      }
      let lo = data.round; let step = 1; let hi = lo; while (calls < MAX_API_CALLS) { const candidate = lo + step; const d = await tryFetch(candidate); if (d) { hi = candidate; data = d; step *= 2; if (candidate > 5000) break; continue; } break; }
      let left = lo; let right = hi; while (left <= right && calls < MAX_API_CALLS) { const mid = Math.floor((left+right)/2); const d = await tryFetch(mid); if (d) { data = d; left = mid+1; } else { right = mid-1; } }
      if (!data) throw new Error('ìµœì‹  íšŒì°¨ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      return data;
    }

    async function loadLottoRound(round) {
      if (lottoState.isLoading) return;
      if (!round || round < 1) { setLottoStatus('ìœ íš¨í•œ íšŒì°¨ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', true); return; }
      lottoState.isLoading = true; updateLottoNavButtons(); setLottoStatus('ë¡œë˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
      try {
        let data = lottoState.cache.get(round);
        if (!data) {
          data = await fetchLottoRound(round);
          if (!data) {
            const msg = 'í•´ë‹¹ íšŒì°¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ' + '<button onclick="location.href=\'/lotto.html\'" class="ml-2 px-2 py-1 bg-blue-600 text-white rounded text-sm">ìµœì‹ íšŒì°¨ í™•ì¸</button>';
            throw new Error(msg);
          }
          lottoState.cache.set(round, data);
        }
        renderLottoView(data);
      } catch (err) {
        console.error(err);
        setLottoStatus(err.message || 'ë¡œë˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', true, true);
      } finally {
        lottoState.isLoading = false; updateLottoNavButtons();
      }
    }

    async function refreshLatestLottoRound() {
      if (lottoState.isLoading) return; lottoState.isLoading = true; setLottoStatus('ìµœì‹  íšŒì°¨ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...'); updateLottoNavButtons();
      try {
        const latestData = await findLatestLottoRound(); lottoState.cache.set(latestData.round, latestData); lottoState.latestRound = latestData.round; renderLottoView(latestData);
      } catch (err) { console.error(err); setLottoStatus(err.message || 'ìµœì‹  íšŒì°¨ í™•ì¸ ì‹¤íŒ¨', true); }
      finally { lottoState.isLoading = false; updateLottoNavButtons(); }
    }

    async function moveLottoRound(delta) { if (!delta || !lottoState.currentRound) return; const target = lottoState.currentRound + delta; if (target < 1) return; if (delta > 0 && lottoState.latestRound && target > lottoState.latestRound) return; await loadLottoRound(target); }

    async function jumpToLottoRound() { const input = $('#lottoRoundInput'); if (!input) return; const round = parseInt(input.value, 10); if (!round || round < 1) { setLottoStatus('íšŒì°¨ ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.', true); return; } await loadLottoRound(round); }

    document.addEventListener('DOMContentLoaded', () => {
      $('#year').textContent = new Date().getFullYear();
      $('#refreshLatestBtn').addEventListener('click', refreshLatestLottoRound);
      $('#lottoPrevBtn').addEventListener('click', () => moveLottoRound(-1));
      $('#lottoNextBtn').addEventListener('click', () => moveLottoRound(1));
      $('#lottoJumpBtn').addEventListener('click', jumpToLottoRound);
      const roundInput = $('#lottoRoundInput'); if (roundInput) roundInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); jumpToLottoRound(); } });

      // ìë™ìœ¼ë¡œ ìµœì‹  íšŒì°¨ë¥¼ ì¦‰ì‹œ íƒìƒ‰í•˜ì§€ ì•Šë„ë¡ ë³€ê²½í•©ë‹ˆë‹¤.
      // ì™¸ë¶€ API í˜¸ì¶œì´ ëŠë¦¬ê±°ë‚˜ ì°¨ë‹¨ëœ í™˜ê²½ì—ì„œ í˜ì´ì§€ê°€ 'ë¡œë”© ì¤‘' ìƒíƒœë¡œ ì˜¤ë˜ ë¨¸ë¬´ë¥´ëŠ” ë¬¸ì œë¥¼ ì™„í™”í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.
      setLottoStatus('ìµœì‹  íšŒì°¨ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ìš°ì¸¡ ìƒë‹¨ì˜ "ìµœì‹ íšŒì°¨" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
      updateLottoNavButtons();
    });
  </script>
</body>
</html>
