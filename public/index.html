<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>ì†Œì•¡ê²°ì œ Â· ì‹ ìš©ì¹´ë“œ ì •ìƒ,ì‚¬ê¸°ì—…ì²´ ì •ë³´ ì»¤ë®¤ë‹ˆí‹°</title>
  <meta name="description" content="ì†Œì•¡ê²°ì œ ë° ì‹ ìš©ì¹´ë“œ ì—…ì²´ë“¤ì˜ ì •ìƒ/ì‚¬ê¸° ì •ë³´ë¥¼ ê³µìœ í•˜ëŠ” ì»¤ë®¤ë‹ˆí‹°. ì•ˆì „í•œ ê±°ë˜ë¥¼ ìœ„í•´ ì‹¤ì œ ì‚¬ìš©ì ì •ë³´ ê³µìœ " />
  <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1" />
  <meta name="keywords" content="ì†Œì•¡ê²°ì œ, ì‹ ìš©ì¹´ë“œ, ì •ìƒì—…ì²´, ì‚¬ê¸°ì—…ì²´, ì—…ì²´ ë¦¬ë·°, ì‚¬ê¸° ì‹ ê³ , ì»¤ë®¤ë‹ˆí‹°, ì—…ì²´ì •ë³´, ì‚¬ê¸°ì‚¬ì´íŠ¸" />
  <meta name="author" content="ì‚¬ê¸° ì—…ì²´ì •ë³´ ì»¤ë®¤ë‹ˆí‹°" />
  <meta name="theme-color" content="#1d4ed8" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />
  
  <!-- ê²€ìƒ‰ ì—”ì§„ ìµœì í™” -->
  <link id="canonicalLink" rel="canonical" href="https://example.com/" />
  <link id="alternateKo" rel="alternate" hreflang="ko" href="https://example.com/" />
  <link id="alternateDefault" rel="alternate" hreflang="x-default" href="https://example.com/" />
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="ko_KR" />
  <meta property="og:site_name" content="ì—…ì²´ì •ë³´ ì»¤ë®¤ë‹ˆí‹°" />
  <meta property="og:title" content="ì†Œì•¡ê²°ì œ Â· ì‹ ìš©ì¹´ë“œ ì—…ì²´ ì •ë³´ ì»¤ë®¤ë‹ˆí‹°" />
  <meta property="og:description" content="ì •ìƒ ì—…ì²´ì™€ ì‚¬ê¸°ì—…ì²´ ì •ë³´ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê³µìœ í•˜ê³  ê²€ì¦í•˜ëŠ” ì»¤ë®¤ë‹ˆí‹°" />
  <meta property="og:url" content="https://example.com/" />
  <meta property="og:image" content="https://via.placeholder.com/1200x630.png?text=%F0%9F%92%B3+Community" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:type" content="image/png" />
  
  <!-- Twitter / X -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ì†Œì•¡ê²°ì œ Â· ì‹ ìš©ì¹´ë“œ ì—…ì²´ ì •ë³´ ì»¤ë®¤ë‹ˆí‹°" />
  <meta name="twitter:description" content="ì •ìƒ ì—…ì²´ì™€ ì‚¬ê¸°ì—…ì²´ ì •ë³´ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê³µìœ í•˜ê³  ê²€ì¦í•˜ëŠ” ì»¤ë®¤ë‹ˆí‹°" />
  <meta name="twitter:url" content="https://example.com/" />
  <meta name="twitter:image" content="https://via.placeholder.com/1200x630.png?text=%F0%9F%92%B3+Community" />
  <meta name="twitter:creator" content="@community" />
  
  <!-- ê²€ìƒ‰ ì—”ì§„ ë©”íƒ€ -->
  <meta name="language" content="Korean" />
  <meta name="revisit-after" content="7 days" />
  <meta name="rating" content="general" />
  <meta name="distribution" content="global" />
  
  <!-- Preconnect for Performance -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com" />
  <link rel="dns-prefetch" href="https://cdn.tailwindcss.com" />
  
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="bg-white border-b shadow-sm">
    <div class="max-w-6xl mx-auto px-4 py-4">
        <div>
          <h1 class="text-2xl font-bold text-blue-600">ğŸ’³ ì—…ì²´ì •ë³´ ì»¤ë®¤ë‹ˆí‹°</h1>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <nav class="space-x-2 text-sm">
            <button onclick="showSection('companies')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ì—…ì²´ëª©ë¡</button>
            <button onclick="showSection('add-company')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">ì—…ì²´ë“±ë¡</button>
            <button onclick="showSection('posts')" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">ììœ ê²Œì‹œíŒ</button>
            <a href="/trending" class="inline-block px-4 py-2 border border-blue-300 text-blue-600 rounded hover:bg-blue-50">ì‚¬ê¸° ì •ë³´ ê³µìœ </a>
            <button id="mypageBtn" onclick="showSection('mypage')" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 hidden">ë§ˆì´í˜ì´ì§€</button>
            <button id="adminMenuBtn" onclick="showSection('admin')" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 hidden">ê´€ë¦¬ì</button>
          </nav>
          <div id="authArea" class="flex items-center gap-2 text-sm">
            <button onclick="openAuthModal('login')" class="px-3 py-1 border border-blue-500 text-blue-600 rounded hover:bg-blue-50">ë¡œê·¸ì¸</button>
            <button onclick="openAuthModal('register')" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">íšŒì›ê°€ì…</button>
          </div>
        </div>
      
      <!-- ê²€ìƒ‰ ë° í•„í„° -->
      <div class="flex flex-wrap gap-3 items-center">
        <select id="categoryFilter" class="border rounded px-3 py-2">
          <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
          <option value="credit">ì‹ ìš©ì¹´ë“œ</option>
          <option value="payment">ì†Œì•¡ê²°ì œ</option>
          <option value="scam">ì‚¬ê¸°ì‚¬ì´íŠ¸</option>
          <option value="other">ê¸°íƒ€</option>
        </select>
        <select id="typeFilter" class="border rounded px-3 py-2">
          <option value="">ì „ì²´ ë¶„ë¥˜</option>
          <option value="safe">ì •ìƒì—…ì²´</option>
          <option value="fraud">ì‚¬ê¸°ì—…ì²´</option>
          <option value="other">ê¸°íƒ€</option>
        </select>
        <input id="searchInput" type="text" placeholder="ì—…ì²´ëª… ê²€ìƒ‰..." class="border rounded px-3 py-2 flex-1 min-w-0">
        <button onclick="searchCompanies()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">ê²€ìƒ‰</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <!-- ì—…ì²´ ëª©ë¡ ì„¹ì…˜ -->
    <section id="companies-section" class="mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">ì—…ì²´ ì •ë³´</h2>
        <div class="text-sm text-gray-600">
          ğŸŸ¢ ì •ìƒì—…ì²´ | ğŸ”´ ì‚¬ê¸°ì—…ì²´ | âšª ê¸°íƒ€ | ğŸ’³ ì‹ ìš©ì¹´ë“œ | ğŸ“± ì†Œì•¡ê²°ì œ | âš ï¸ ì‚¬ê¸°ì‚¬ì´íŠ¸ | â” ê¸°íƒ€ ì¹´í…Œê³ ë¦¬
        </div>
      </div>
      <div id="companies" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <!-- ì—…ì²´ ë“±ë¡ ì„¹ì…˜ -->
    <section id="add-company-section" class="mb-8 hidden">
      <h2 class="text-xl font-semibold mb-4">ì—…ì²´ ì •ë³´ ë“±ë¡</h2>
      <div class="bg-white rounded-lg p-6 shadow">
        <form id="companyForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input id="companyName" type="text" placeholder="ì—…ì²´ëª… *" class="border rounded px-3 py-2" required />
            <input id="companyWriter" type="text" placeholder="ì‘ì„±ì (ì„ íƒ, ê¸°ë³¸: ìµëª…)" class="border rounded px-3 py-2" />
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <select id="companyCategory" class="border rounded px-3 py-2" required>
              <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ *</option>
              <option value="credit">ì‹ ìš©ì¹´ë“œ</option>
              <option value="payment">ì†Œì•¡ê²°ì œ</option>
              <option value="scam">ì‚¬ê¸°ì‚¬ì´íŠ¸</option>
              <option value="other">ê¸°íƒ€</option>
            </select>
            <select id="companyType" class="border rounded px-3 py-2" required>
              <option value="">ë¶„ë¥˜ ì„ íƒ *</option>
              <option value="safe">ì •ìƒì—…ì²´</option>
              <option value="fraud">ì‚¬ê¸°ì—…ì²´</option>
              <option value="other">ê¸°íƒ€</option>
            </select>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input id="companyWebsite" type="url" placeholder="ì›¹ì‚¬ì´íŠ¸ ì£¼ì†Œ" class="border rounded px-3 py-2" />
            <input id="companyPhone" type="tel" placeholder="ì „í™”ë²ˆí˜¸" class="border rounded px-3 py-2" />
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input id="companyMessenger" type="text" placeholder="ë©”ì‹ ì € (ì¹´ì¹´ì˜¤í†¡, í…”ë ˆê·¸ë¨ ë“±)" class="border rounded px-3 py-2" />
            <input id="companyMessengerId" type="text" placeholder="ë©”ì‹ ì € ID" class="border rounded px-3 py-2" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">í‰ì </label>
            <select id="companyRating" class="border rounded px-3 py-2">
              <option value="0">í‰ì  ì—†ìŒ</option>
              <option value="1">â­ 1ì </option>
              <option value="2">â­â­ 2ì </option>
              <option value="3">â­â­â­ 3ì </option>
              <option value="4">â­â­â­â­ 4ì </option>
              <option value="5">â­â­â­â­â­ 5ì </option>
            </select>
          </div>
          <textarea id="companyDescription" placeholder="ìƒì„¸ ì„¤ëª… (ì´ìš© í›„ê¸°, ì£¼ì˜ì‚¬í•­ ë“±)" rows="4" class="w-full border rounded px-3 py-2"></textarea>
          <div class="flex gap-3">
            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ë“±ë¡</button>
            <button type="button" onclick="document.getElementById('companyForm').reset()" class="px-6 py-2 bg-gray-200 rounded hover:bg-gray-300">ì´ˆê¸°í™”</button>
          </div>
        </form>
      </div>
    </section>

    <!-- ììœ ê²Œì‹œíŒ ì„¹ì…˜ -->
    <section id="posts-section" class="mb-8 hidden">
      <div class="flex flex-wrap gap-3 items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">ììœ ê²Œì‹œíŒ</h2>
        <div class="flex gap-2 items-center">
          <select id="postCategoryFilter" class="border rounded px-3 py-2 text-sm">
            <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
            <option value="free">ììœ ê²Œì‹œíŒ</option>
          </select>
          <button onclick="toggleWrite()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ê¸€ì“°ê¸°</button>
        </div>
      </div>
  <p class="text-xs text-gray-500 mb-4">* í˜„ì¬ëŠ” ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ë§Œ ì œê³µë˜ë©°, ì¶”í›„ ì—¬ëŸ¬ ì¹´í…Œê³ ë¦¬ë¡œ í™•ì¥í•  ìˆ˜ ìˆë„ë¡ ì¤€ë¹„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>

      <div id="write-post" class="bg-white rounded-lg p-6 shadow mb-6 hidden">
        <form id="postForm" class="space-y-4">
          <input id="postTitle" type="text" placeholder="ì œëª©" class="w-full border rounded px-3 py-2" />
          <div class="flex items-center justify-between text-sm text-gray-600">
            <span>ì‘ì„±ì</span>
            <span id="postAuthorLabel" class="font-medium text-gray-800">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</span>
          </div>
          <select id="postCategory" class="w-full border rounded px-3 py-2">
            <option value="free">ììœ ê²Œì‹œíŒ</option>
          </select>
          <textarea id="postContent" placeholder="ë‚´ìš©" rows="6" class="w-full border rounded px-3 py-2"></textarea>
          <div class="flex gap-3">
            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ë“±ë¡</button>
            <button type="button" onclick="toggleWrite()" class="px-6 py-2 bg-gray-200 rounded hover:bg-gray-300">ì·¨ì†Œ</button>
          </div>
        </form>
      </div>
      
      <div id="posts" class="space-y-4"></div>
    </section>

    <!-- ê´€ë¦¬ì ì„¹ì…˜ -->
    <section id="admin-section" class="mb-8 hidden">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-red-600 mb-4">ğŸ›¡ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
        
        <!-- íƒ­ -->
        <div class="flex gap-2 mb-4 border-b">
          <button onclick="switchAdminTab('posts')" class="admin-tab-btn px-4 py-2 border-b-2 border-red-600 text-red-600 font-semibold" data-tab="posts">ê²Œì‹œê¸€ ê´€ë¦¬</button>
          <button onclick="switchAdminTab('users')" class="admin-tab-btn px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800" data-tab="users">íšŒì› ê´€ë¦¬</button>
        </div>

        <!-- ê²Œì‹œê¸€ ê´€ë¦¬ íƒ­ -->
        <div id="admin-posts-tab" class="admin-tab hidden">
          <div class="bg-white rounded-lg p-6 shadow overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-100 border-b">
                <tr>
                  <th class="text-left px-4 py-2">ID</th>
                  <th class="text-left px-4 py-2">ì œëª©</th>
                  <th class="text-left px-4 py-2">ì‘ì„±ì</th>
                  <th class="text-left px-4 py-2">ì‘ì„±ì¼</th>
                  <th class="text-left px-4 py-2">ëŒ“ê¸€ ìˆ˜</th>
                  <th class="text-left px-4 py-2">ì‘ì—…</th>
                </tr>
              </thead>
              <tbody id="admin-posts-list" class="divide-y"></tbody>
            </table>
          </div>
        </div>

        <!-- íšŒì› ê´€ë¦¬ íƒ­ -->
        <div id="admin-users-tab" class="admin-tab hidden">
          <div class="bg-white rounded-lg p-6 shadow overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-100 border-b">
                <tr>
                  <th class="text-left px-4 py-2">ID</th>
                  <th class="text-left px-4 py-2">ì•„ì´ë””</th>
                  <th class="text-left px-4 py-2">ì´ë©”ì¼</th>
                  <th class="text-left px-4 py-2">ê¶Œí•œ</th>
                  <th class="text-left px-4 py-2">ê°€ì…ì¼</th>
                  <th class="text-left px-4 py-2">ì‘ì—…</th>
                </tr>
              </thead>
              <tbody id="admin-users-list" class="divide-y"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- ë§ˆì´í˜ì´ì§€ ì„¹ì…˜ -->
    <section id="mypage-section" class="mb-8 hidden">
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-2xl font-bold text-purple-600 mb-4">ğŸ‘¤ ë§ˆì´í˜ì´ì§€</h2>
        
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="flex border-b mb-6">
          <button onclick="switchMypageTab('myinfo')" class="mypage-tab-btn px-4 py-2 border-b-2 border-purple-600 text-purple-600 font-semibold" data-tab="myinfo">ë‚´ ì •ë³´</button>
          <button onclick="switchMypageTab('myposts')" class="mypage-tab-btn px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800" data-tab="myposts">ë‚´ê°€ ì“´ ê¸€</button>
          <button onclick="switchMypageTab('mycomments')" class="mypage-tab-btn px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800" data-tab="mycomments">ë‚´ê°€ ì“´ ëŒ“ê¸€</button>
          <button onclick="switchMypageTab('changepw')" class="mypage-tab-btn px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-gray-800" data-tab="changepw">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
        </div>

        <!-- ë‚´ ì •ë³´ íƒ­ -->
        <div id="mypage-myinfo-tab" class="mypage-tab">
          <div class="bg-gray-50 p-6 rounded">
            <h3 class="text-lg font-bold mb-4">ğŸ§‘ ê³„ì • ì •ë³´</h3>
            <div class="space-y-3">
              <p><strong>ì•„ì´ë””:</strong> <span id="myinfo-username">-</span></p>
              <p><strong>ì´ë©”ì¼:</strong> <span id="myinfo-email">-</span></p>
              <p><strong>ê°€ì…ì¼:</strong> <span id="myinfo-joined">-</span></p>
              <p><strong>ê¶Œí•œ:</strong> <span id="myinfo-role">-</span></p>
            </div>
          </div>
        </div>

        <!-- ë‚´ê°€ ì“´ ê¸€ íƒ­ -->
        <div id="mypage-myposts-tab" class="mypage-tab hidden">
          <div id="mypage-posts-list" class="space-y-4">
            <p class="text-gray-500">ë¡œë”© ì¤‘...</p>
          </div>
        </div>

        <!-- ë‚´ê°€ ì“´ ëŒ“ê¸€ íƒ­ -->
        <div id="mypage-mycomments-tab" class="mypage-tab hidden">
          <div id="mypage-comments-list" class="space-y-4">
            <p class="text-gray-500">ë¡œë”© ì¤‘...</p>
          </div>
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ íƒ­ -->
        <div id="mypage-changepw-tab" class="mypage-tab hidden">
          <div class="bg-gray-50 p-6 rounded max-w-md">
            <h3 class="text-lg font-bold mb-4">ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="current-password" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" class="w-full px-3 py-2 border rounded">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="new-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (8ì ì´ìƒ)" class="w-full px-3 py-2 border rounded">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" id="confirm-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="w-full px-3 py-2 border rounded">
              </div>
              <button onclick="changePassword()" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
              <div id="changepw-message" class="text-sm"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ê²Œì‹œê¸€ í¸ì§‘ ëª¨ë‹¬ -->
    <div id="editPostModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="closeEditPostModal()">
      <div class="flex items-center justify-center p-4 min-h-screen">
        <div class="bg-white rounded-lg max-w-2xl w-full shadow-lg" onclick="event.stopPropagation()">
          <div class="flex items-center justify-between border-b px-6 py-4">
            <h3 class="text-lg font-semibold">ê²Œì‹œê¸€ í¸ì§‘</h3>
            <button onclick="closeEditPostModal()" class="text-2xl text-gray-500 hover:text-gray-700">&times;</button>
          </div>
          <div class="px-6 py-5">
            <form id="editPostForm" class="space-y-4">
              <input type="hidden" id="editPostId" />
              <div>
                <label class="block text-sm font-medium mb-1">ì œëª©</label>
                <input id="editPostTitle" type="text" class="w-full border rounded px-3 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">ë‚´ìš©</label>
                <textarea id="editPostContent" rows="6" class="w-full border rounded px-3 py-2"></textarea>
              </div>
              <div class="flex gap-2 justify-end">
                <button type="button" onclick="closeEditPostModal()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">ì·¨ì†Œ</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ì €ì¥</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- ì—…ì²´ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="companyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="closeCompanyModal()">
      <div class="flex items-center justify-center p-4 min-h-screen">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto" onclick="event.stopPropagation()">
          <div id="companyDetail" class="p-6"></div>
        </div>
      </div>
    </div>

    <!-- ê²Œì‹œê¸€ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="postModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="closePostModal()">
      <div class="flex items-center justify-center p-4 min-h-screen">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto" onclick="event.stopPropagation()">
          <div id="postDetail" class="p-6"></div>
        </div>
      </div>
    </div>

    <!-- ì¸ì¦ ëª¨ë‹¬ -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="closeAuthModal()">
      <div class="flex items-center justify-center p-4 min-h-screen">
        <div class="bg-white rounded-lg w-full max-w-md shadow-lg" onclick="event.stopPropagation()">
          <div class="flex items-center justify-between border-b px-6 py-4">
            <h3 id="authModalTitle" class="text-lg font-semibold">ë¡œê·¸ì¸</h3>
            <button onclick="closeAuthModal()" class="text-2xl text-gray-500 hover:text-gray-700">&times;</button>
          </div>
          <div class="px-6 py-5">
            <div id="authError" class="hidden mb-4 text-sm text-red-600"></div>
            <form id="loginForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="loginUsername">ì•„ì´ë””</label>
                <input id="loginUsername" type="text" class="w-full border rounded px-3 py-2" autocomplete="username" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="loginPassword">ë¹„ë°€ë²ˆí˜¸</label>
                <input id="loginPassword" type="password" class="w-full border rounded px-3 py-2" autocomplete="current-password" />
              </div>
              <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ë¡œê·¸ì¸</button>
              <button type="button" onclick="openResetRequestModal()" class="w-full text-sm text-blue-600 hover:underline">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</button>
            </form>

            <form id="registerForm" class="space-y-4 hidden">
              <div>
                <label class="block text-sm font-medium mb-1" for="registerUsername">ì•„ì´ë””</label>
                <input id="registerUsername" type="text" class="w-full border rounded px-3 py-2" autocomplete="username" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="registerEmail">ì´ë©”ì¼</label>
                <input id="registerEmail" type="email" class="w-full border rounded px-3 py-2" autocomplete="email" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="registerPassword">ë¹„ë°€ë²ˆí˜¸</label>
                <input id="registerPassword" type="password" class="w-full border rounded px-3 py-2" autocomplete="new-password" />
                <p class="mt-1 text-xs text-gray-500">ë¹„ë°€ë²ˆí˜¸ëŠ” 6~64ìì˜ ì˜ë¬¸/ìˆ«ì ì¡°í•©ìœ¼ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
              </div>
              <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">íšŒì›ê°€ì…</button>
            </form>
          </div>
          <div class="border-t px-6 py-4 text-sm text-gray-600 text-center">
            <span id="authModalSwitchText">ì•„ì§ ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?</span>
            <button id="authModalSwitchButton" type="button" onclick="switchAuthModal()" class="ml-2 text-blue-600 hover:underline">íšŒì›ê°€ì…</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­ ëª¨ë‹¬ -->
    <div id="resetRequestModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="closeResetRequestModal()">
      <div class="flex items-center justify-center p-4 min-h-screen">
        <div class="bg-white rounded-lg w-full max-w-md shadow-lg" onclick="event.stopPropagation()">
          <div class="flex items-center justify-between border-b px-6 py-4">
            <h3 class="text-lg font-semibold">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</h3>
            <button onclick="closeResetRequestModal()" class="text-2xl text-gray-500 hover:text-gray-700">&times;</button>
          </div>
          <div class="px-6 py-5 space-y-4">
            <p class="text-sm text-gray-600">ê°€ì… ì‹œ ì‚¬ìš©í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ë©´ ì¬ì„¤ì • ë§í¬ë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.</p>
            <div id="resetRequestMessage" class="hidden text-sm"></div>
            <form id="resetRequestForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="resetEmail">ì´ë©”ì¼</label>
                <input id="resetEmail" type="email" class="w-full border rounded px-3 py-2" autocomplete="email" />
              </div>
              <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ì¬ì„¤ì • ë§í¬ ë³´ë‚´ê¸°</button>
            </form>
          </div>
          <div class="border-t px-6 py-4 text-xs text-gray-500" id="resetDevHint" hidden></div>
        </div>
      </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì™„ë£Œ ëª¨ë‹¬ -->
    <div id="resetCompleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="closeResetCompleteModal()">
      <div class="flex items-center justify-center p-4 min-h-screen">
        <div class="bg-white rounded-lg w-full max-w-md shadow-lg" onclick="event.stopPropagation()">
          <div class="flex items-center justify-between border-b px-6 py-4">
            <h3 class="text-lg font-semibold">ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</h3>
            <button onclick="closeResetCompleteModal()" class="text-2xl text-gray-500 hover:text-gray-700">&times;</button>
          </div>
          <div class="px-6 py-5 space-y-4">
            <p class="text-sm text-gray-600">ì´ë©”ì¼ë¡œ ë°›ì€ ì¬ì„¤ì • ë§í¬ì˜ í† í°ì„ ì…ë ¥í•˜ê³  ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì„¸ìš”.</p>
            <div id="resetCompleteMessage" class="hidden text-sm"></div>
            <form id="resetCompleteForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="resetToken">í† í°</label>
                <input id="resetToken" type="text" class="w-full border rounded px-3 py-2" placeholder="ì´ë©”ì¼ë¡œ ì „ë‹¬ëœ í† í°" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="resetPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                <input id="resetPassword" type="password" class="w-full border rounded px-3 py-2" autocomplete="new-password" />
                <p class="mt-1 text-xs text-gray-500">ë¹„ë°€ë²ˆí˜¸ëŠ” 6~64ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
              </div>
              <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="border-t bg-white mt-12">
    <div class="max-w-6xl mx-auto px-4 py-8 text-sm text-gray-500 text-center">
      <p>âš ï¸ ë³¸ ì‚¬ì´íŠ¸ì˜ ì •ë³´ëŠ” ì‚¬ìš©ìê°€ ì œê³µí•œ ê²ƒìœ¼ë¡œ, ì •í™•ì„±ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <p>ê±°ë˜ ì „ ë°˜ë“œì‹œ ì§ì ‘ í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
      <p class="mt-2">Â© <span id="year"></span> ì—…ì²´ì •ë³´ ì»¤ë®¤ë‹ˆí‹°</p>
    </div>
  </footer>

  <template id="companyCard">
    <div class="bg-white border rounded-lg p-4 shadow hover:shadow-md transition-shadow cursor-pointer">
      <div class="flex justify-between items-start mb-2">
        <h3 class="font-semibold text-lg" data-role="name"></h3>
        <span class="text-2xl" data-role="icon"></span>
      </div>
      <div class="space-y-1 text-sm text-gray-600 mb-3">
        <div data-role="category-type"></div>
        <div data-role="rating"></div>
        <div data-role="contact"></div>
      </div>
      <p class="text-sm text-gray-700 line-clamp-3" data-role="description"></p>
      <div class="mt-3 text-xs text-gray-500" data-role="meta"></div>
      <div class="mt-3 flex items-center justify-between">
        <a data-role="permalink" class="text-sm text-blue-600 hover:underline" href="#" rel="noopener">ê²€ìƒ‰ì—”ì§„ìš© ìƒì„¸í˜ì´ì§€</a>
        <button data-role="share" type="button" class="flex items-center gap-1 text-gray-600 hover:text-blue-600 text-sm">
          <span>ğŸ”—</span><span>ê³µìœ </span>
        </button>
      </div>
    </div>
  </template>

  <template id="postItem">
    <article class="bg-white border rounded-lg p-4 shadow">
      <h3 class="font-semibold"><a data-role="title-link" class="hover:underline" href="#"></a></h3>
      <p class="text-sm text-gray-500 mt-1" data-role="meta"></p>
      <p class="mt-2" data-role="content"></p>
      <div class="mt-3 flex items-center justify-between text-sm">
        <a data-role="permalink" class="text-blue-600 hover:underline" href="#" rel="noopener">ì „ì²´ ê¸€ ë³´ê¸°</a>
        <button data-role="share" type="button" class="flex items-center gap-1 text-gray-600 hover:text-blue-600">
          <span>ğŸ”—</span><span>ê³µìœ </span>
        </button>
      </div>
    </article>
  </template>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // ììœ ê²Œì‹œíŒ ì¹´í…Œê³ ë¦¬ (ì¶”í›„ í™•ì¥ ëŒ€ë¹„)
    const POST_CATEGORY_OPTIONS = [
      { value: 'free', label: 'ììœ ê²Œì‹œíŒ' }
    ];

    let currentSection = 'companies';
    let currentUser = null;
    let authModalMode = 'login';

    function updateHeadSeoMeta() {
      const origin = window.location.origin;
      const canonicalUrl = `${origin}${window.location.pathname}${window.location.search}`;
      const homeUrl = `${origin}/`;

      const canonicalLink = $('#canonicalLink');
      if (canonicalLink) {
        canonicalLink.setAttribute('href', canonicalUrl);
      }
      const altKo = $('#alternateKo');
      if (altKo) {
        altKo.setAttribute('href', homeUrl);
      }
      const altDefault = $('#alternateDefault');
      if (altDefault) {
        altDefault.setAttribute('href', homeUrl);
      }

      const metaDescription = document.querySelector('meta[name="description"]')?.getAttribute('content') || 'ì •ìƒ ì—…ì²´ì™€ ì‚¬ê¸°ì—…ì²´ ì •ë³´ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê³µìœ í•˜ê³  ê²€ì¦í•˜ëŠ” ì»¤ë®¤ë‹ˆí‹°';
      const titleText = document.title || 'ì†Œì•¡ê²°ì œ Â· ì‹ ìš©ì¹´ë“œ ì—…ì²´ ì •ë³´ ì»¤ë®¤ë‹ˆí‹°';

      const setMeta = (selector, value) => {
        const element = document.querySelector(selector);
        if (element && value) {
          element.setAttribute('content', value);
        }
      };

      setMeta('meta[property="og:title"]', titleText);
      setMeta('meta[property="og:description"]', metaDescription);
      setMeta('meta[property="og:url"]', canonicalUrl);
      setMeta('meta[name="twitter:title"]', titleText);
      setMeta('meta[name="twitter:description"]', metaDescription);
      setMeta('meta[name="twitter:url"]', canonicalUrl);

      const existingLd = document.querySelector('script[data-dynamic-ld="website"]');
      if (existingLd && existingLd.parentNode) {
        existingLd.parentNode.removeChild(existingLd);
      }
      const ldData = {
        '@context': 'https://schema.org',
        '@type': 'WebSite',
        name: 'ì—…ì²´ì •ë³´ ì»¤ë®¤ë‹ˆí‹°',
        url: homeUrl,
        potentialAction: {
          '@type': 'SearchAction',
          target: `${origin}/?search={search_term_string}`,
          'query-input': 'required name=search_term_string'
        }
      };
      const ldScript = document.createElement('script');
      ldScript.type = 'application/ld+json';
      ldScript.dataset.dynamicLd = 'website';
      ldScript.text = JSON.stringify(ldData);
      document.head.appendChild(ldScript);
    }

    function setAuthState(user) {
      currentUser = user;
      updateAuthArea();
      updatePostAuthorLabel();
      const writeBox = $('#write-post');
      if (!user && writeBox && !writeBox.classList.contains('hidden')) {
        writeBox.classList.add('hidden');
      }
    }

    function updateAuthArea() {
      const area = $('#authArea');
      const adminBtn = $('#adminMenuBtn');
      const mypageBtn = $('#mypageBtn');
      if (!area) return;
      
      // ê´€ë¦¬ì ë©”ë‰´ í‘œì‹œ ì—¬ë¶€ ì—…ë°ì´íŠ¸
      if (adminBtn) {
        if (currentUser && currentUser.is_admin) {
          adminBtn.classList.remove('hidden');
        } else {
          adminBtn.classList.add('hidden');
        }
      }
      
      // ë§ˆì´í˜ì´ì§€ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ ì—…ë°ì´íŠ¸
      if (mypageBtn) {
        if (currentUser) {
          mypageBtn.classList.remove('hidden');
        } else {
          mypageBtn.classList.add('hidden');
        }
      }
      
      if (currentUser) {
        area.innerHTML = `
          <span class="text-gray-700">ğŸ‘‹ ${currentUser.username}${currentUser.is_admin ? ' (ê´€ë¦¬ì)' : ''}</span>
          <button onclick="logoutUser()" class="px-3 py-1 border border-gray-300 text-gray-700 rounded hover:bg-gray-100">ë¡œê·¸ì•„ì›ƒ</button>
        `;
      } else {
        area.innerHTML = `
          <button onclick="openAuthModal('login')" class="px-3 py-1 border border-blue-500 text-blue-600 rounded hover:bg-blue-50">ë¡œê·¸ì¸</button>
          <button onclick="openAuthModal('register')" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">íšŒì›ê°€ì…</button>
        `;
      }
    }

    function updatePostAuthorLabel() {
      const label = $('#postAuthorLabel');
      if (!label) return;
      label.textContent = currentUser ? currentUser.username : 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤';
    }

    function setAuthError(message) {
      const box = $('#authError');
      if (!box) return;
      if (message) {
        box.textContent = message;
        box.classList.remove('hidden');
      } else {
        box.textContent = '';
        box.classList.add('hidden');
      }
    }

    function clearAuthForms() {
      $('#loginForm')?.reset();
      $('#registerForm')?.reset();
    }

    function toggleAuthForms() {
      const loginForm = $('#loginForm');
      const registerForm = $('#registerForm');
      const title = $('#authModalTitle');
      const switchText = $('#authModalSwitchText');
      const switchButton = $('#authModalSwitchButton');

      if (!loginForm || !registerForm || !title || !switchText || !switchButton) return;

      if (authModalMode === 'login') {
        loginForm.classList.remove('hidden');
        registerForm.classList.add('hidden');
        title.textContent = 'ë¡œê·¸ì¸';
        switchText.textContent = 'ì•„ì§ ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?';
        switchButton.textContent = 'íšŒì›ê°€ì…';
        setTimeout(() => { $('#loginUsername')?.focus(); }, 50);
      } else {
        loginForm.classList.add('hidden');
        registerForm.classList.remove('hidden');
        title.textContent = 'íšŒì›ê°€ì…';
        switchText.textContent = 'ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?';
        switchButton.textContent = 'ë¡œê·¸ì¸';
        setTimeout(() => { $('#registerUsername')?.focus(); }, 50);
      }
    }

    function openAuthModal(mode = 'login') {
      authModalMode = mode;
      clearAuthForms();
      setAuthError('');
      toggleAuthForms();
      const modal = $('#authModal');
      if (modal) modal.classList.remove('hidden');
    }

    function switchAuthModal(mode) {
      authModalMode = mode || (authModalMode === 'login' ? 'register' : 'login');
      clearAuthForms();
      setAuthError('');
      toggleAuthForms();
    }

    function closeAuthModal() {
      const modal = $('#authModal');
      if (modal) modal.classList.add('hidden');
      setAuthError('');
      clearAuthForms();
    }

    function setResetRequestMessage(message, type = 'info') {
      const box = $('#resetRequestMessage');
      if (!box) return;
      box.textContent = message || '';
      box.classList.remove('text-red-600', 'text-green-600', 'text-blue-600');
      if (!message) {
        box.classList.add('hidden');
        return;
      }
      box.classList.remove('hidden');
      const colorClass = type === 'success' ? 'text-green-600' : (type === 'info' ? 'text-blue-600' : 'text-red-600');
      box.classList.add(colorClass);
    }

    function setResetCompleteMessage(message, type = 'info') {
      const box = $('#resetCompleteMessage');
      if (!box) return;
      box.textContent = message || '';
      box.classList.remove('text-red-600', 'text-green-600', 'text-blue-600');
      if (!message) {
        box.classList.add('hidden');
        return;
      }
      box.classList.remove('hidden');
      const colorClass = type === 'success' ? 'text-green-600' : (type === 'info' ? 'text-blue-600' : 'text-red-600');
      box.classList.add(colorClass);
    }

    function openResetRequestModal() {
      closeAuthModal();
      const form = $('#resetRequestForm');
      if (form) form.reset();
      setResetRequestMessage('');
      const hint = $('#resetDevHint');
      if (hint) {
        hint.textContent = '';
        hint.hidden = true;
      }
      const modal = $('#resetRequestModal');
      if (modal) {
        modal.classList.remove('hidden');
        setTimeout(() => { $('#resetEmail')?.focus(); }, 50);
      }
    }

    function closeResetRequestModal() {
      const modal = $('#resetRequestModal');
      if (modal) modal.classList.add('hidden');
      setResetRequestMessage('');
      const form = $('#resetRequestForm');
      if (form) form.reset();
      const hint = $('#resetDevHint');
      if (hint) {
        hint.textContent = '';
        hint.hidden = true;
      }
    }

    function openResetCompleteModal(token = '') {
      closeResetRequestModal();
      closeAuthModal();
      const form = $('#resetCompleteForm');
      if (form) form.reset();
      setResetCompleteMessage('');
      const modal = $('#resetCompleteModal');
      if (modal) {
        modal.classList.remove('hidden');
        const tokenField = $('#resetToken');
        if (tokenField && token) {
          tokenField.value = token;
        }
        setTimeout(() => {
          const tokenField = $('#resetToken');
          const passwordField = $('#resetPassword');
          if (tokenField && tokenField.value && passwordField) {
            passwordField.focus();
          } else if (tokenField) {
            tokenField.focus();
          }
        }, 50);
      }
    }

    function closeResetCompleteModal() {
      const modal = $('#resetCompleteModal');
      if (modal) modal.classList.add('hidden');
      setResetCompleteMessage('');
      const form = $('#resetCompleteForm');
      if (form) form.reset();
    }

    async function fetchCurrentUser() {
      try {
        const res = await fetch('/api/auth/me', { credentials: 'same-origin' });
        const json = await res.json();
        if (json.success) {
          setAuthState(json.user);
        } else {
          setAuthState(null);
        }
      } catch (e) {
        console.error(e);
        setAuthState(null);
      }
    }

    async function logoutUser() {
      try {
        await fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' });
      } catch (e) {
        console.error(e);
      } finally {
        setAuthState(null);
        if (currentSection === 'posts') {
          loadPosts();
        }
      }
    }

    // ì„¹ì…˜ ì „í™˜
    function showSection(section) {
      // ë§ˆì´í˜ì´ì§€ ê¶Œí•œ í™•ì¸
      if (section === 'mypage' && !currentUser) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
      if (section === 'admin' && (!currentUser || !currentUser.is_admin)) {
        alert('ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      ['companies', 'add-company', 'posts', 'admin', 'mypage'].forEach(s => {
        const el = $(`#${s}-section`);
        if (el) el.classList.add('hidden');
      });
      const targetSection = $(`#${section}-section`);
      if (targetSection) targetSection.classList.remove('hidden');
      currentSection = section;

      if (section === 'companies') {
        loadCompanies();
      } else if (section === 'posts') {
        loadPosts();
      } else if (section === 'admin') {
        loadAdminDashboard();
      } else if (section === 'mypage') {
        switchMypageTab('myinfo');
      }
    }

    // ì—…ì²´ ì¹´ë“œ ì•„ì´ì½˜ ë° ìƒ‰ìƒ
    function getCompanyIcon(category, type) {
      const icons = {
        'payment-safe': 'ğŸ“±ğŸŸ¢',
        'payment-fraud': 'ğŸ“±ğŸ”´',
        'payment-other': 'ğŸ“±âšª',
        'credit-safe': 'ğŸ’³ğŸŸ¢',
        'credit-fraud': 'ğŸ’³ğŸ”´',
        'credit-other': 'ğŸ’³âšª',
        'scam-safe': 'âš ï¸ğŸŸ¢',
        'scam-fraud': 'âš ï¸ğŸ”´',
        'scam-other': 'âš ï¸âšª',
        'other-safe': 'â”ï¿½',
        'other-fraud': 'â”ï¿½ğŸ”´',
        'other-other': 'â”âšª'
      };
      return icons[`${category}-${type}`] || 'â“';
    }

    function getCategoryText(category) {
      switch (category) {
        case 'payment':
          return 'ì†Œì•¡ê²°ì œ';
        case 'credit':
          return 'ì‹ ìš©ì¹´ë“œ';
        case 'scam':
          return 'ì‚¬ê¸°ì‚¬ì´íŠ¸';
        case 'other':
          return 'ê¸°íƒ€';
        default:
          return 'ê¸°íƒ€';
      }
    }

    function getTypeText(type) {
      switch (type) {
        case 'safe':
          return 'ì •ìƒì—…ì²´';
        case 'fraud':
          return 'ì‚¬ê¸°ì—…ì²´';
        case 'other':
          return 'ê¸°íƒ€';
        default:
          return 'ê¸°íƒ€';
      }
    }

    function getRatingText(rating) {
      if (!rating || rating === 0) return 'í‰ì  ì—†ìŒ';
      return 'â­'.repeat(rating) + ` ${rating}ì `;
    }

    function getPostCategoryLabel(value) {
      const found = POST_CATEGORY_OPTIONS.find(o => o.value === value);
      return found ? found.label : 'ììœ ê²Œì‹œíŒ';
    }

    function populatePostCategorySelectors() {
      const filter = $('#postCategoryFilter');
      if (filter) {
        filter.innerHTML = '<option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>' + POST_CATEGORY_OPTIONS.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
      }

      const writeSelect = $('#postCategory');
      if (writeSelect) {
        writeSelect.innerHTML = POST_CATEGORY_OPTIONS.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
      }
    }

    // ì—…ì²´ ëª©ë¡ ë¡œë“œ
    async function loadCompanies() {
      const box = $('#companies');
      box.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</div>';
      
      try {
        const category = $('#categoryFilter').value;
        const type = $('#typeFilter').value;
        const search = $('#searchInput').value;
        
        const params = new URLSearchParams();
        if (category) params.append('category', category);
        if (type) params.append('type', type);
        if (search) params.append('search', search);
        
        const res = await fetch(`/api/companies?${params}`);
        const json = await res.json();
        
        if (!json.success) throw new Error(json.error || 'load error');
        
        box.innerHTML = '';
        
        if (json.companies.length === 0) {
          box.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">ë“±ë¡ëœ ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }
        
        json.companies.forEach(company => {
          const node = $('#companyCard').content.cloneNode(true);
          const card = node.querySelector('div');
          
          card.onclick = () => showCompanyDetail(company.id);
          
          node.querySelector('[data-role="name"]').textContent = company.name;
          node.querySelector('[data-role="icon"]').textContent = getCompanyIcon(company.category, company.type);
          node.querySelector('[data-role="category-type"]').textContent = `${getCategoryText(company.category)} Â· ${getTypeText(company.type)}`;
          node.querySelector('[data-role="rating"]').textContent = getRatingText(company.rating);
          
          let contact = '';
          if (company.website) contact += `ğŸŒ ${company.website}`;
          if (company.phone) contact += (contact ? ' Â· ' : '') + `ğŸ“ ${company.phone}`;
          if (company.messenger && company.messenger_id) contact += (contact ? ' Â· ' : '') + `ğŸ’¬ ${company.messenger}: ${company.messenger_id}`;
          node.querySelector('[data-role="contact"]').textContent = contact || 'ì—°ë½ì²˜ ì •ë³´ ì—†ìŒ';
          
          const desc = company.description || 'ìƒì„¸ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';
          node.querySelector('[data-role="description"]').textContent = desc.length > 100 ? desc.slice(0, 100) + '...' : desc;
          
          let metaText = `${company.writer || 'ìµëª…'} Â· ${new Date(company.created).toLocaleDateString()}`;
          if (company.report_count > 0) {
            metaText += ` Â· ğŸš¨ ì‹ ê³  ${company.report_count}ê±´`;
          }
          node.querySelector('[data-role="meta"]').textContent = metaText;

          const permalink = node.querySelector('[data-role="permalink"]');
          if (permalink) {
            permalink.setAttribute('href', `/companies/${company.id}`);
            permalink.addEventListener('click', (event) => event.stopPropagation());
          }

          const shareButton = node.querySelector('[data-role="share"]');
          if (shareButton) {
            shareButton.addEventListener('click', (event) => {
              event.preventDefault();
              event.stopPropagation();
              const shareText = `${company.name} - ${getCategoryText(company.category)} Â· ${getTypeText(company.type)}`;
              shareLink(`/companies/${company.id}`, shareText, `${company.description || ''}`.substring(0, 100));
            });
          }
          
          // ì‚¬ê¸°ì—…ì²´ëŠ” ë¹¨ê°„ í…Œë‘ë¦¬
          if (company.type === 'fraud') {
            card.classList.add('border-red-300');
          }
          
          box.appendChild(node);
        });
      } catch (e) {
        console.error(e);
        box.innerHTML = '<div class="col-span-full text-center py-8 text-red-600">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }

    // ì—…ì²´ ê²€ìƒ‰
    function searchCompanies() {
      if (currentSection === 'companies') {
        loadCompanies();
      }
    }

    // ì—…ì²´ ìƒì„¸ ì •ë³´ í‘œì‹œ
    async function showCompanyDetail(companyId) {
      const modal = $('#companyModal');
      const detail = $('#companyDetail');

      currentSection = 'companies';
      
      detail.innerHTML = '<div class="text-center py-8">ë¡œë”©ì¤‘...</div>';
      modal.classList.remove('hidden');
      
      try {
        const res = await fetch(`/api/companies/${companyId}`);
        const json = await res.json();
        
        if (!json.success) throw new Error(json.error);
        
        const { company, reviews } = json;
        
        detail.innerHTML = `
          <div class="border-b pb-4 mb-4">
            <div class="flex justify-between items-start">
              <div>
                <h2 class="text-2xl font-bold">${company.name}</h2>
                <div class="text-lg mt-1">
                  ${getCompanyIcon(company.category, company.type)} ${getCategoryText(company.category)} Â· ${getTypeText(company.type)}
                </div>
              </div>
              <button onclick="closeCompanyModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="mt-3 space-y-2 text-sm text-gray-600">
              ${company.website ? `<div>ğŸŒ <a href="${company.website}" target="_blank" class="text-blue-600 hover:underline">${company.website}</a></div>` : ''}
              ${company.phone ? `<div>ğŸ“ ${company.phone}</div>` : ''}
              ${company.messenger && company.messenger_id ? `<div>ğŸ’¬ ${company.messenger}: ${company.messenger_id}</div>` : ''}
              <div>â­ ${getRatingText(company.rating)}</div>
              ${company.report_count > 0 ? `<div class="text-red-600">ğŸš¨ ì‹ ê³  ${company.report_count}ê±´</div>` : ''}
              <div class="text-xs text-gray-500">ë“±ë¡: ${company.writer || 'ìµëª…'} Â· ${new Date(company.created).toLocaleString()}</div>
              <div><a href="/companies/${company.id}" class="text-blue-600 hover:underline">ê²€ìƒ‰ì—”ì§„ìš© ìƒì„¸í˜ì´ì§€ ì—´ê¸°</a></div>
            </div>
          </div>
          
          <div class="mb-6">
            <h3 class="font-semibold mb-2">ìƒì„¸ ì„¤ëª…</h3>
            <p class="text-gray-700 whitespace-pre-wrap">${company.description || 'ìƒì„¸ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>
          </div>
          
          <div class="mb-6">
            <h3 class="font-semibold mb-3">ë¦¬ë·° ë° ì‹ ê³  (${reviews.length}ê°œ)</h3>
            <div class="space-y-3 max-h-64 overflow-y-auto">
              ${reviews.length > 0 ? reviews.map(review => `
                <div class="border rounded p-3 ${review.review_type === 'report' ? 'bg-red-50 border-red-200' : 'bg-gray-50'}">
                  <div class="flex justify-between items-start mb-2">
                    <span class="text-sm font-medium ${review.review_type === 'report' ? 'text-red-600' : 'text-blue-600'}">
                      ${review.review_type === 'report' ? 'ğŸš¨ ì‹ ê³ ' : 'ğŸ’¬ ë¦¬ë·°'}
                      ${review.rating ? ` Â· ${getRatingText(review.rating)}` : ''}
                    </span>
                    <span class="text-xs text-gray-500">${new Date(review.created).toLocaleDateString()}</span>
                  </div>
                  <p class="text-sm text-gray-700 whitespace-pre-wrap">${review.content}</p>
                  <div class="text-xs text-gray-500 mt-1">ì‘ì„±ì: ${review.writer || 'ìµëª…'}</div>
                </div>
              `).join('') : '<div class="text-gray-500 text-center py-4">ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'}
            </div>
          </div>
          
          <div class="border-t pt-4">
            <h3 class="font-semibold mb-3">ë¦¬ë·°/ì‹ ê³  ì‘ì„±</h3>
            <form id="reviewForm" class="space-y-3">
              <input type="hidden" id="reviewCompanyId" value="${company.id}">
              <div class="flex gap-3">
                <select id="reviewType" class="border rounded px-3 py-2">
                  <option value="review">ğŸ’¬ ë¦¬ë·° ì‘ì„±</option>
                  <option value="report">ğŸš¨ ì‹ ê³ í•˜ê¸°</option>
                </select>
                <select id="reviewRating" class="border rounded px-3 py-2">
                  <option value="">í‰ì  ì„ íƒ</option>
                  <option value="1">â­ 1ì </option>
                  <option value="2">â­â­ 2ì </option>
                  <option value="3">â­â­â­ 3ì </option>
                  <option value="4">â­â­â­â­ 4ì </option>
                  <option value="5">â­â­â­â­â­ 5ì </option>
                </select>
                <input id="reviewWriter" type="text" placeholder="ì‘ì„±ì(ì„ íƒ)" class="border rounded px-3 py-2">
              </div>
              <textarea id="reviewContent" placeholder="ë¦¬ë·° ë˜ëŠ” ì‹ ê³  ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..." rows="3" class="w-full border rounded px-3 py-2"></textarea>
              <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ë“±ë¡</button>
            </form>
          </div>
        `;
        
        // ë¦¬ë·° í¼ ì´ë²¤íŠ¸ ì¶”ê°€
        $('#reviewForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          await submitReview();
        });
        
      } catch (e) {
        console.error(e);
        detail.innerHTML = '<div class="text-center py-8 text-red-600">ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }

    function closeCompanyModal() {
      $('#companyModal').classList.add('hidden');
    }

    function renderPostComments(section, comments) {
      if (!section) return;
      const list = section.querySelector('[data-role="comments-list"]');
      const count = section.querySelector('[data-role="comments-count"]');
      if (count) {
        count.textContent = Array.isArray(comments) ? comments.length : 0;
      }
      if (!list) return;
      list.innerHTML = '';

      if (!comments || comments.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'text-sm text-gray-500 border border-dashed border-gray-300 rounded-lg px-4 py-6 text-center bg-gray-50';
        empty.textContent = 'ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.';
        list.appendChild(empty);
        return;
      }

      comments.forEach((comment) => {
        const item = document.createElement('div');
        item.className = 'border rounded-lg bg-white p-3 shadow-sm';

        const header = document.createElement('div');
        header.className = 'flex justify-between items-start mb-2';

        const writerEl = document.createElement('span');
        writerEl.className = 'text-sm font-medium text-gray-700';
        writerEl.textContent = comment.writer || 'ìµëª…';

        const dateEl = document.createElement('span');
        dateEl.className = 'text-xs text-gray-500';
        try {
          dateEl.textContent = new Date(comment.created || Date.now()).toLocaleString('ko-KR');
        } catch (e) {
          dateEl.textContent = comment.created || '';
        }

        header.appendChild(writerEl);
        header.appendChild(dateEl);

        const body = document.createElement('p');
        body.className = 'text-sm text-gray-800 whitespace-pre-wrap';
        body.textContent = comment.content || '';

        item.appendChild(header);
        item.appendChild(body);
        list.appendChild(item);
      });
    }

    function setupCommentForm(section, postId) {
      if (!section) return;
      const container = section.querySelector('[data-role="comment-form"]');
      if (!container) return;

      if (!currentUser) {
        container.innerHTML = `
          <div class="border border-dashed border-gray-300 rounded-lg px-4 py-3 bg-gray-50 text-sm text-gray-600">
            ëŒ“ê¸€ì„ ë‚¨ê¸°ë ¤ë©´ <button type="button" class="text-blue-600 hover:underline" data-action="open-login">ë¡œê·¸ì¸</button>í•´ì£¼ì„¸ìš”.
          </div>
        `;
        const loginBtn = container.querySelector('[data-action="open-login"]');
        if (loginBtn) {
          loginBtn.addEventListener('click', () => openAuthModal('login'));
        }
        return;
      }

      const textareaId = `commentContent-${postId}`;
      const formId = `commentForm-${postId}`;
      container.innerHTML = `
        <form class="space-y-3" id="${formId}">
          <textarea id="${textareaId}" rows="3" class="w-full border rounded px-3 py-2" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
          <div class="flex items-center justify-between">
            <span class="text-sm text-gray-500">ì‘ì„±ì: ${currentUser.username}</span>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ë“±ë¡</button>
          </div>
        </form>
      `;

      const form = container.querySelector(`#${formId}`);
      if (!form) return;
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const textarea = form.querySelector(`#${textareaId}`);
        if (!textarea) return;
        const content = textarea.value.trim();
        if (!content) {
          alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        try {
          const res = await fetch(`/api/posts/${postId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
          });
          const json = await res.json();
          if (!res.ok || !json.success) {
            throw new Error(json.error || 'ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
          textarea.value = '';
          renderPostComments(section, json.comments || []);
          if (currentSection === 'posts') {
            loadPosts();
          }
        } catch (err) {
          console.error(err);
          alert(err.message || 'ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }

    async function showPostDetail(postId) {
      const id = parseInt(postId, 10);
      const modal = $('#postModal');
      const detail = $('#postDetail');
      if (!modal || !detail || Number.isNaN(id)) return;

      currentSection = 'posts';
      detail.innerHTML = '<div class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</div>';
      modal.classList.remove('hidden');

      try {
        const res = await fetch(`/api/posts/${id}`);
        const json = await res.json();
        if (!res.ok || !json.success) {
          throw new Error(json.error || 'ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }

        const post = json.post;
        const comments = json.comments || [];
        const title = post.title || '(ì œëª© ì—†ìŒ)';
        const meta = `${getPostCategoryLabel(post.category)} Â· ${post.writer || 'ìµëª…'} Â· ${new Date(post.created).toLocaleString()}`;
        detail.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <div>
              <h2 class="text-xl font-semibold text-gray-800">${title}</h2>
              <p class="text-sm text-gray-500 mt-1">${meta}</p>
            </div>
            <button onclick="closePostModal()" class="text-2xl text-gray-500 hover:text-gray-700">&times;</button>
          </div>
          <div class="whitespace-pre-wrap leading-relaxed text-gray-800" data-role="post-body"></div>
          <div class="mt-6 flex items-center justify-between text-sm">
            <a href="/posts/${post.id}" class="text-blue-600 hover:underline">ê²€ìƒ‰ì—”ì§„ìš© ê³ ì • ì£¼ì†Œ ì—´ê¸°</a>
            <button type="button" class="flex items-center gap-1 text-gray-600 hover:text-blue-600" data-role="share-post">
              <span>ğŸ”—</span><span>ê³µìœ </span>
            </button>
          </div>
          <div class="mt-8 border-t pt-5" data-role="comments-section">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold text-gray-800">ëŒ“ê¸€</h3>
              <span class="text-sm text-gray-500">ì´ <span data-role="comments-count">${comments.length}</span>ê°œ</span>
            </div>
            <div class="mt-3 space-y-3" data-role="comments-list"></div>
            <div class="mt-4" data-role="comment-form"></div>
          </div>
        `;
        const body = detail.querySelector('[data-role="post-body"]');
        if (body) {
          body.textContent = post.content || '';
        }

        const shareBtn = detail.querySelector('[data-role="share-post"]');
        if (shareBtn) {
          shareBtn.addEventListener('click', () => {
            const shareText = textOnly(post.content).slice(0, 120);
            shareLink(`/posts/${post.id}`, post.title || 'ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œê¸€', shareText);
          });
        }

        const commentsSection = detail.querySelector('[data-role="comments-section"]');
        if (commentsSection) {
          renderPostComments(commentsSection, comments);
          setupCommentForm(commentsSection, post.id);
        }
      } catch (err) {
        console.error(err);
        detail.innerHTML = `
          <div class="text-center py-10">
            <p class="text-red-600 mb-3">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>
            <p class="text-sm text-gray-500">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
            <button onclick="closePostModal()" class="mt-4 px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">ë‹«ê¸°</button>
          </div>
        `;
      }
    }

    function closePostModal() {
      const modal = $('#postModal');
      if (modal) modal.classList.add('hidden');
    }

    // ë¦¬ë·° ì œì¶œ
    async function submitReview() {
      const companyId = $('#reviewCompanyId').value;
      const reviewType = $('#reviewType').value;
      const rating = $('#reviewRating').value;
      const content = $('#reviewContent').value.trim();
      const writer = $('#reviewWriter').value.trim();
      
      if (!content) {
        alert('ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const res = await fetch(`/api/companies/${companyId}/reviews`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            review_type: reviewType,
            rating: rating ? parseInt(rating) : null,
            content,
            writer
          })
        });
        
        const json = await res.json();
        if (!json.success) throw new Error(json.error);
        
        alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        showCompanyDetail(companyId); // ìƒˆë¡œê³ ì¹¨
      } catch (e) {
        console.error(e);
        alert('ë“±ë¡ ì‹¤íŒ¨: ' + e.message);
      }
    }

    // ì—…ì²´ ë“±ë¡
    $('#companyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = $('#companyName').value.trim();
      const category = $('#companyCategory').value;
      const type = $('#companyType').value;
      const website = $('#companyWebsite').value.trim();
      const phone = $('#companyPhone').value.trim();
      const messenger = $('#companyMessenger').value.trim();
      const messenger_id = $('#companyMessengerId').value.trim();
      const description = $('#companyDescription').value.trim();
      const rating = $('#companyRating').value;
      const writer = $('#companyWriter').value.trim();
      
      if (!name || !category || !type) {
        alert('í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        const res = await fetch('/api/companies', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name, category, type, website, phone, messenger, messenger_id, description, rating: parseInt(rating), writer
          })
        });
        
        const json = await res.json();
        if (!json.success) throw new Error(json.error);
        
        alert('ì—…ì²´ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        $('#companyForm').reset();
        showSection('companies');
      } catch (e) {
        console.error(e);
        alert('ë“±ë¡ ì‹¤íŒ¨: ' + e.message);
      }
    });

    function textOnly(html) {
      const d = document.createElement('div');
      d.innerHTML = String(html || '');
      return (d.textContent || d.innerText || '').replace(/\s+/g,' ').trim();
    }

    // ê²Œì‹œê¸€ ê´€ë ¨ í•¨ìˆ˜ë“¤
    function toggleWrite() {
      if (!currentUser) {
        alert('ê²Œì‹œê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        openAuthModal('login');
        return;
      }

      const box = $('#write-post');
      box.classList.toggle('hidden');
      if (!box.classList.contains('hidden')) {
        const filterValue = ($('#postCategoryFilter') && $('#postCategoryFilter').value) || 'free';
        if ($('#postCategory')) {
          $('#postCategory').value = filterValue || 'free';
        }
      }
    }

    async function loadPosts() {
      const box = $('#posts');
      box.innerHTML = '<div class="text-center py-8 text-gray-500">ë¡œë”©ì¤‘...</div>';
      try {
        const category = $('#postCategoryFilter') ? $('#postCategoryFilter').value : '';
        const params = new URLSearchParams();
        if (category) params.append('category', category);
        const query = params.toString();
        const res = await fetch(`/api/posts${query ? `?${query}` : ''}`);
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'load error');
        
        box.innerHTML = '';
        json.posts.forEach(p => {
          const node = $('#postItem').content.cloneNode(true);
          const article = node.querySelector('article');
          if (article) {
            article.classList.add('cursor-pointer', 'transition-shadow', 'hover:shadow-md');
            article.addEventListener('click', (event) => {
              if (event.target.closest('a')) return;
              showPostDetail(p.id);
            });
          }
          const titleLink = node.querySelector('[data-role="title-link"]');
          if (titleLink) {
            titleLink.textContent = p.title || '(ì œëª© ì—†ìŒ)';
            titleLink.setAttribute('href', `/posts/${p.id}`);
            titleLink.addEventListener('click', (event) => {
              event.preventDefault();
              event.stopPropagation();
              showPostDetail(p.id);
            });
          }
          const categoryLabel = getPostCategoryLabel(p.category);
          const commentCount = typeof p.comment_count === 'number' ? p.comment_count : 0;
          node.querySelector('[data-role="meta"]').textContent = `${categoryLabel} Â· ${p.writer || 'ìµëª…'} Â· ${new Date(p.created).toLocaleString()} Â· ğŸ’¬ ${commentCount}ëŒ“ê¸€`;
          node.querySelector('[data-role="content"]').textContent = textOnly(p.content).slice(0, 300);
          const permalink = node.querySelector('[data-role="permalink"]');
          if (permalink) {
            permalink.setAttribute('href', `/posts/${p.id}`);
            permalink.addEventListener('click', (event) => event.stopPropagation());
          }
          const shareButton = node.querySelector('[data-role="share"]');
          if (shareButton) {
            shareButton.addEventListener('click', (event) => {
              event.preventDefault();
              event.stopPropagation();
              const shareText = textOnly(p.content).slice(0, 100);
              shareLink(`/posts/${p.id}`, p.title || 'ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œê¸€', shareText);
            });
          }
          box.appendChild(node);
        });
        if (!box.children.length) box.innerHTML = '<div class="text-center py-8 text-gray-500">ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      } catch (e) {
        console.error(e);
        box.innerHTML = '<div class="text-center py-8 text-red-600">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }

    $('#postForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        openAuthModal('login');
        return;
      }
      const title = $('#postTitle').value.trim();
      const content = $('#postContent').value.trim();
      const category = $('#postCategory') ? $('#postCategory').value : 'free';
      if (!content) { alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
      try {
        const res = await fetch('/api/posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, content, category })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'create error');
        $('#postForm').reset();
        toggleWrite();
        await loadPosts();
      } catch (e) {
        console.error(e);
        alert('ë“±ë¡ ì‹¤íŒ¨: ' + e.message);
      }
    });

    // ê³µìœ  ê¸°ëŠ¥
    function shareLink(path, title = 'ì»¤ë®¤ë‹ˆí‹°', text = '') {
      const url = `${window.location.origin}${path}`;
      const shareData = {
        title: title,
        text: text ? `${text}\n` : '',
        url: url
      };

      // Web Share API ì§€ì› ì—¬ë¶€ í™•ì¸
      if (navigator.share) {
        navigator.share(shareData).catch(err => {
          console.warn('Share failed:', err);
          fallbackCopyToClipboard(url);
        });
      } else {
        // Web Share API ë¯¸ì§€ì› ì‹œ í´ë¦½ë³´ë“œ ë³µì‚¬
        fallbackCopyToClipboard(url);
      }
    }

    function fallbackCopyToClipboard(url) {
      const textarea = document.createElement('textarea');
      textarea.value = url;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤:\n' + url);
      } catch (e) {
        alert('ë§í¬: ' + url);
      }
      document.body.removeChild(textarea);
    }

    // ëŒ“ê¸€ ë Œë”ë§
    function renderPostComments(section, comments) {
      const list = section.querySelector('[data-role="comments-list"]');
      if (!list) return;
      
      list.innerHTML = '';
      comments.forEach(c => {
        const div = document.createElement('div');
        div.className = 'bg-gray-50 p-3 rounded text-sm';
        div.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="font-medium text-gray-700">${c.writer || 'ìµëª…'}</div>
            <div class="text-xs text-gray-500">${new Date(c.created).toLocaleString()}</div>
          </div>
          <p class="mt-1 text-gray-700">${c.content}</p>
        `;
        list.appendChild(div);
      });
    }

    // ëŒ“ê¸€ í¼ ì„¤ì •
    function setupCommentForm(section, postId) {
      const form = section.querySelector('[data-role="comment-form"]');
      if (!form) return;
      
      form.innerHTML = `
        <form data-post-id="${postId}" class="space-y-2">
          <textarea placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." class="w-full border rounded px-3 py-2 text-sm" rows="2" required></textarea>
          <div class="flex gap-2 justify-end">
            <button type="submit" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">ë“±ë¡</button>
          </div>
        </form>
      `;
      
      const formEl = form.querySelector('form');
      if (formEl) {
        formEl.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!currentUser) {
            alert('ëŒ“ê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            openAuthModal('login');
            return;
          }
          
          const textarea = formEl.querySelector('textarea');
          const content = textarea.value.trim();
          if (!content) {
            alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
          }
          
          try {
            const res = await fetch(`/api/posts/${postId}/comments`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content }),
              credentials: 'same-origin'
            });
            
            const json = await res.json();
            if (!json.success) throw new Error(json.error);
            
            textarea.value = '';
            await showPostDetail(postId); // ëŒ“ê¸€ ì¶”ê°€ í›„ ìƒˆë¡œê³ ì¹¨
          } catch (e) {
            console.error(e);
            alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: ' + e.message);
          }
        });
      }
    }

    // ========== ê´€ë¦¬ì í•¨ìˆ˜ ==========

    // ê´€ë¦¬ì íƒ­ ì „í™˜
    function switchAdminTab(tab) {
      $$('.admin-tab-btn').forEach(btn => {
        btn.classList.remove('border-red-600', 'text-red-600', 'font-semibold');
        btn.classList.add('border-transparent', 'text-gray-600', 'hover:text-gray-800');
      });
      $$(`[data-tab="${tab}"]`).forEach(btn => {
        btn.classList.add('border-red-600', 'text-red-600', 'font-semibold');
        btn.classList.remove('border-transparent', 'text-gray-600', 'hover:text-gray-800');
      });

      $$('.admin-tab').forEach(t => t.classList.add('hidden'));
      $(`#admin-${tab}-tab`).classList.remove('hidden');

      if (tab === 'posts') {
        loadAdminPosts();
      } else if (tab === 'users') {
        loadAdminUsers();
      }
    }

    // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë¡œë“œ
    async function loadAdminDashboard() {
      switchAdminTab('posts');
    }

    // ê´€ë¦¬ì: ê²Œì‹œê¸€ ëª©ë¡ ë¡œë“œ
    async function loadAdminPosts() {
      try {
        const res = await fetch('/api/admin/posts', { credentials: 'same-origin' });
        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        const tbody = $('#admin-posts-list');
        tbody.innerHTML = '';
        json.posts.forEach(p => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50';
          row.innerHTML = `
            <td class="px-4 py-2">${p.id}</td>
            <td class="px-4 py-2 max-w-xs truncate">${p.title || '(ì œëª© ì—†ìŒ)'}</td>
            <td class="px-4 py-2">${p.writer || 'ìµëª…'}</td>
            <td class="px-4 py-2 text-xs text-gray-500">${new Date(p.created).toLocaleString()}</td>
            <td class="px-4 py-2 text-center">${p.comment_count || 0}</td>
            <td class="px-4 py-2 flex gap-2">
              <button onclick="openEditPostModal(${p.id}, '${p.title ? p.title.replace(/'/g, "\\'") : ''}', '${p.content ? p.content.replace(/'/g, "\\'").substring(0, 100) : ''}')" class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">í¸ì§‘</button>
              <button onclick="deleteAdminPost(${p.id})" class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">ì‚­ì œ</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (e) {
        console.error(e);
        alert('ê²Œì‹œê¸€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
      }
    }

    // ê²Œì‹œê¸€ í¸ì§‘ ëª¨ë‹¬ ì—´ê¸°
    function openEditPostModal(id, title, content) {
      const modal = $('#editPostModal');
      if (!modal) return;
      
      $('#editPostId').value = id;
      $('#editPostTitle').value = title;
      $('#editPostContent').value = content;
      modal.classList.remove('hidden');
    }

    // ê²Œì‹œê¸€ í¸ì§‘ ëª¨ë‹¬ ë‹«ê¸°
    function closeEditPostModal() {
      const modal = $('#editPostModal');
      if (modal) modal.classList.add('hidden');
    }

    // ê²Œì‹œê¸€ ì €ì¥ (ê´€ë¦¬ì)
    $('#editPostForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = parseInt($('#editPostId').value, 10);
      const title = $('#editPostTitle').value.trim();
      const content = $('#editPostContent').value.trim();

      try {
        const res = await fetch(`/api/admin/posts/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, content }),
          credentials: 'same-origin'
        });

        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        alert('ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        closeEditPostModal();
        loadAdminPosts();
      } catch (e) {
        console.error(e);
        alert('ìˆ˜ì • ì‹¤íŒ¨: ' + e.message);
      }
    });

    // ê²Œì‹œê¸€ ì‚­ì œ (ê´€ë¦¬ì)
    async function deleteAdminPost(id) {
      if (!confirm('ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const res = await fetch(`/api/admin/posts/${id}`, {
          method: 'DELETE',
          credentials: 'same-origin'
        });

        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadAdminPosts();
      } catch (e) {
        console.error(e);
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
      }
    }

    // ê´€ë¦¬ì: íšŒì› ëª©ë¡ ë¡œë“œ
    async function loadAdminUsers() {
      try {
        const res = await fetch('/api/admin/users', { credentials: 'same-origin' });
        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        const tbody = $('#admin-users-list');
        tbody.innerHTML = '';
        json.users.forEach(u => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50';
          const adminStatus = u.is_admin ? 'ğŸ‘‘ ê´€ë¦¬ì' : 'ì¼ë°˜ ì‚¬ìš©ì';
          const toggleBtnText = u.is_admin ? 'ê¶Œí•œ í•´ì œ' : 'ê´€ë¦¬ì ì„¤ì •';
          const toggleBtnClass = u.is_admin ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600';
          
          // ìì‹ ì˜ í–‰ì—ì„œëŠ” ê¶Œí•œ ë³€ê²½ ë²„íŠ¼ ë¹„í™œì„±í™”
          const isOwnRow = currentUser && currentUser.id === u.id;
          
          row.innerHTML = `
            <td class="px-4 py-2">${u.id}</td>
            <td class="px-4 py-2">${u.username}</td>
            <td class="px-4 py-2 max-w-xs truncate">${u.email}</td>
            <td class="px-4 py-2 text-sm">${adminStatus}</td>
            <td class="px-4 py-2 text-xs text-gray-500">${new Date(u.created).toLocaleString()}</td>
            <td class="px-4 py-2 flex gap-2">
              <button onclick="toggleAdminUser(${u.id})" class="px-2 py-1 text-xs text-white rounded ${toggleBtnClass}" ${isOwnRow ? 'disabled' : ''}>${toggleBtnText}</button>
              <button onclick="deleteAdminUser(${u.id})" class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600" ${isOwnRow ? 'disabled' : ''}>ì‚­ì œ</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (e) {
        console.error(e);
        alert('íšŒì› ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
      }
    }

    // íšŒì› ê´€ë¦¬ì ê¶Œí•œ í† ê¸€ (ê´€ë¦¬ì)
    async function toggleAdminUser(userId) {
      try {
        const res = await fetch(`/api/admin/users/${userId}/toggle-admin`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin'
        });

        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        alert(json.message);
        loadAdminUsers();
      } catch (e) {
        console.error(e);
        alert('ê¶Œí•œ ë³€ê²½ ì‹¤íŒ¨: ' + e.message);
      }
    }

    // íšŒì› ì‚­ì œ (ê´€ë¦¬ì)
    async function deleteAdminUser(userId) {
      if (!confirm('ì´ íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const res = await fetch(`/api/admin/users/${userId}`, {
          method: 'DELETE',
          credentials: 'same-origin'
        });

        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        alert('íšŒì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadAdminUsers();
      } catch (e) {
        console.error(e);
        alert('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
      }
    }

    // í•„í„° ë³€ê²½ ì‹œ ìë™ ê²€ìƒ‰
    $('#categoryFilter').addEventListener('change', searchCompanies);
    $('#typeFilter').addEventListener('change', searchCompanies);
    $('#searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchCompanies();
    });

    document.addEventListener('DOMContentLoaded', async () => {
      updateHeadSeoMeta();
      $('#year').textContent = new Date().getFullYear();
      populatePostCategorySelectors();
      updateAuthArea();
      updatePostAuthorLabel();

      const postCategoryFilter = $('#postCategoryFilter');
      if (postCategoryFilter) {
        postCategoryFilter.addEventListener('change', () => {
          if (currentSection === 'posts') loadPosts();
        });
      }

      const loginForm = $('#loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          setAuthError('');
          const username = $('#loginUsername').value.trim();
          const password = $('#loginPassword').value;
          if (!username || !password) {
            setAuthError('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
          }
          try {
            const res = await fetch('/api/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password }),
              credentials: 'same-origin'
            });
            const json = await res.json();
            if (!res.ok || !json.success) {
              throw new Error(json.error || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            setAuthState(json.user);
            closeAuthModal();
            if (currentSection === 'posts') {
              loadPosts();
            }
          } catch (err) {
            console.error(err);
            setAuthError(err.message || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        });
      }

      const registerForm = $('#registerForm');
      if (registerForm) {
        registerForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          setAuthError('');
          const username = $('#registerUsername').value.trim();
          const emailField = $('#registerEmail');
          const passwordField = $('#registerPassword');
          const email = emailField ? emailField.value.trim() : '';
          const password = passwordField ? passwordField.value : '';
          if (!username || !email || !password) {
            setAuthError('ì•„ì´ë””, ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
          }
          if (username.length < 3 || username.length > 20) {
            setAuthError('ì•„ì´ë””ëŠ” 3~20ìì˜ ì˜ë¬¸/ìˆ«ì/_.-ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            return;
          }
          const emailPattern = /^[\w.!#$%&'*+/=?`{|}~-]+@[\w-]+(?:\.[\w-]+)+$/;
          if (!emailPattern.test(email)) {
            setAuthError('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
          }
          if (password.length < 6 || password.length > 64) {
            setAuthError('ë¹„ë°€ë²ˆí˜¸ëŠ” 6~64ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
          }
          try {
            const res = await fetch('/api/auth/register', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, email, password }),
              credentials: 'same-origin'
            });
            const json = await res.json();
            if (!res.ok || !json.success) {
              throw new Error(json.error || 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            setAuthState(json.user);
            closeAuthModal();
            if (currentSection === 'posts') {
              loadPosts();
            }
          } catch (err) {
            console.error(err);
            setAuthError(err.message || 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        });
      }

      const resetRequestForm = $('#resetRequestForm');
      if (resetRequestForm) {
        resetRequestForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          setResetRequestMessage('');
          const emailField = $('#resetEmail');
          const email = emailField ? emailField.value.trim() : '';
          if (!email) {
            setResetRequestMessage('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
          }
          try {
            const res = await fetch('/api/auth/request-reset', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email }),
              credentials: 'same-origin'
            });
            const json = await res.json();
            if (!res.ok || !json.success) {
              throw new Error(json.error || 'ì¬ì„¤ì • ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            setResetRequestMessage(json.message || 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì•ˆë‚´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'success');
            const hint = $('#resetDevHint');
            if (hint) {
              if (json.resetUrl) {
                hint.innerHTML = `í…ŒìŠ¤íŠ¸ìš© ë§í¬: <a href="${json.resetUrl}" class="text-blue-600 hover:underline" target="_blank" rel="noopener">${json.resetUrl}</a>`;
                hint.hidden = false;
              } else {
                hint.textContent = '';
                hint.hidden = true;
              }
            }
            if (json.token) {
              openResetCompleteModal(json.token);
            }
          } catch (err) {
            console.error(err);
            setResetRequestMessage(err.message || 'ì¬ì„¤ì • ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          }
        });
      }

      const resetCompleteForm = $('#resetCompleteForm');
      if (resetCompleteForm) {
        resetCompleteForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          setResetCompleteMessage('');
          const tokenField = $('#resetToken');
          const passwordField = $('#resetPassword');
          const token = tokenField ? tokenField.value.trim() : '';
          const password = passwordField ? passwordField.value : '';
          if (!token || !password) {
            setResetCompleteMessage('í† í°ê³¼ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
          }
          if (password.length < 6 || password.length > 64) {
            setResetCompleteMessage('ë¹„ë°€ë²ˆí˜¸ëŠ” 6~64ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
          }
          try {
            const res = await fetch('/api/auth/reset-password', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token, password }),
              credentials: 'same-origin'
            });
            const json = await res.json();
            if (!res.ok || !json.success) {
              throw new Error(json.error || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            setResetCompleteMessage(json.message || 'ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            setTimeout(() => {
              closeResetCompleteModal();
              openAuthModal('login');
            }, 1500);
          } catch (err) {
            console.error(err);
            setResetCompleteMessage(err.message || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          }
        });
      }

      const currentUrl = new URL(window.location.href);
      if (currentUrl.pathname === '/reset-password') {
        const tokenParam = currentUrl.searchParams.get('token') || '';
        openResetCompleteModal(tokenParam);
        if (!tokenParam) {
          setResetCompleteMessage('í† í°ì´ í™•ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ë©”ì¼ë¡œ ë°›ì€ ë§í¬ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
        }
        window.history.replaceState(null, '', '/');
        updateHeadSeoMeta();
      }

      await fetchCurrentUser();

      const companyParam = currentUrl.searchParams.get('company');
      const postParam = currentUrl.searchParams.get('post');
      const initialSection = companyParam ? 'companies' : (postParam ? 'posts' : 'companies');
      showSection(initialSection);

      if (companyParam) {
        await showCompanyDetail(companyParam);
        currentUrl.searchParams.delete('company');
        const newSearch = currentUrl.searchParams.toString();
        const newPath = newSearch ? `${currentUrl.pathname}?${newSearch}` : currentUrl.pathname;
        window.history.replaceState(null, '', newPath === '' ? '/' : newPath);
        updateHeadSeoMeta();
      } else if (postParam) {
        await showPostDetail(postParam);
        currentUrl.searchParams.delete('post');
        const newSearch = currentUrl.searchParams.toString();
        const newPath = newSearch ? `${currentUrl.pathname}?${newSearch}` : currentUrl.pathname;
        window.history.replaceState(null, '', newPath === '' ? '/' : newPath);
        updateHeadSeoMeta();
      }
    });

    // ë§ˆì´í˜ì´ì§€ í•¨ìˆ˜ë“¤
    function switchMypageTab(tabName) {
      // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
      document.querySelectorAll('.mypage-tab').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      // ëª¨ë“  íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
      document.querySelectorAll('.mypage-tab-btn').forEach(btn => {
        btn.classList.remove('border-purple-600', 'text-purple-600', 'font-semibold');
        btn.classList.add('border-transparent', 'text-gray-600');
      });
      
      // ì„ íƒí•œ íƒ­ í‘œì‹œ
      const selectedTab = $(`#mypage-${tabName}-tab`);
      if (selectedTab) {
        selectedTab.classList.remove('hidden');
      }
      
      // ì„ íƒí•œ íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼
      const selectedBtn = document.querySelector(`.mypage-tab-btn[data-tab="${tabName}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('border-purple-600', 'text-purple-600', 'font-semibold');
        selectedBtn.classList.remove('border-transparent', 'text-gray-600');
      }
      
      // íƒ­ë³„ ë°ì´í„° ë¡œë“œ
      if (tabName === 'myinfo') {
        loadMyInfo();
      } else if (tabName === 'myposts') {
        loadMyPosts();
      } else if (tabName === 'mycomments') {
        loadMyComments();
      }
    }

    function loadMyInfo() {
      if (!currentUser) return;
      $('#myinfo-username').textContent = currentUser.username;
      $('#myinfo-email').textContent = currentUser.email;
      $('#myinfo-role').textContent = currentUser.is_admin ? 'ğŸ‘‘ ê´€ë¦¬ì' : 'ì¼ë°˜ ì‚¬ìš©ì';
      $('#myinfo-joined').textContent = new Date(currentUser.created).toLocaleString();
    }

    async function loadMyPosts() {
      try {
        const res = await fetch('/api/mypage/posts', { credentials: 'same-origin' });
        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        const container = $('#mypage-posts-list');
        if (!container) return;
        
        if (json.posts.length === 0) {
          container.innerHTML = '<p class="text-gray-500">ì‘ì„±í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        container.innerHTML = json.posts.map(post => `
          <div class="bg-white p-4 border rounded hover:shadow">
            <div class="flex justify-between items-start mb-2">
              <h4 class="text-lg font-semibold text-gray-800">
                <a href="javascript:showPostDetail(${post.id})" class="text-blue-600 hover:underline">
                  ${escapeHtml(post.title)}
                </a>
              </h4>
              <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${post.section}</span>
            </div>
            <p class="text-gray-600 text-sm mb-2">${escapeHtml(post.content.substring(0, 100))}...</p>
            <div class="flex justify-between items-center text-xs text-gray-500">
              <span> ${post.comment_count || 0}</span>
              <span>${new Date(post.created).toLocaleString()}</span>
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
        const container = $('#mypage-posts-list');
        if (container) {
          container.innerHTML = `<p class="text-red-500">ê¸€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</p>`;
        }
      }
    }

    async function loadMyComments() {
      try {
        const res = await fetch('/api/mypage/comments', { credentials: 'same-origin' });
        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        const container = $('#mypage-comments-list');
        if (!container) return;
        
        if (json.comments.length === 0) {
          container.innerHTML = '<p class="text-gray-500">ì‘ì„±í•œ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        container.innerHTML = json.comments.map(comment => `
          <div class="bg-white p-4 border rounded">
            <div class="mb-2">
              <p class="text-gray-700">${escapeHtml(comment.content)}</p>
              <p class="text-xs text-gray-500 mt-1">
                <a href="javascript:showPostDetail(${comment.post_id})" class="text-blue-600 hover:underline">
                  ê²Œì‹œê¸€ ë³´ê¸°
                </a>
              </p>
            </div>
            <div class="text-xs text-gray-500">
              ${new Date(comment.created).toLocaleString()}
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
        const container = $('#mypage-comments-list');
        if (container) {
          container.innerHTML = `<p class="text-red-500">ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</p>`;
        }
      }
    }

    async function changePassword() {
      if (!currentUser) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      const currentPw = $('#current-password')?.value || '';
      const newPw = $('#new-password')?.value || '';
      const confirmPw = $('#confirm-password')?.value || '';
      const msgEl = $('#changepw-message');

      if (!currentPw || !newPw || !confirmPw) {
        if (msgEl) msgEl.innerHTML = '<span class="text-red-600">ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>';
        return;
      }

      if (newPw !== confirmPw) {
        if (msgEl) msgEl.innerHTML = '<span class="text-red-600">ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>';
        return;
      }

      if (newPw.length < 8) {
        if (msgEl) msgEl.innerHTML = '<span class="text-red-600">ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.</span>';
        return;
      }

      try {
        const res = await fetch('/api/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            currentPassword: currentPw,
            newPassword: newPw
          }),
          credentials: 'same-origin'
        });

        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        if (msgEl) msgEl.innerHTML = '<span class="text-green-600">âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.</span>';
        $('#current-password').value = '';
        $('#new-password').value = '';
        $('#confirm-password').value = '';
      } catch (e) {
        console.error(e);
        if (msgEl) msgEl.innerHTML = `<span class="text-red-600">ë³€ê²½ ì‹¤íŒ¨: ${e.message}</span>`;
      }
    }
  </script>
</body>
</html>
